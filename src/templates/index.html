<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>The Green - Environmental Impact Visualization</title>
    <link rel="icon" href="data:,">
    
    <!-- Load required libraries -->
    <script src="https://unpkg.com/@deck.gl/core@^8.9.0/dist.min.js"></script>
    <script src="https://unpkg.com/@deck.gl/layers@^8.9.0/dist.min.js"></script>
    <script src="https://unpkg.com/@deck.gl/mapbox@^8.9.0/dist.min.js"></script>
    <script src="https://api.mapbox.com/mapbox-gl-js/v2.15.0/mapbox-gl.js"></script>
    <link href="https://api.mapbox.com/mapbox-gl-js/v2.15.0/mapbox-gl.css" rel="stylesheet"/>
    
    <style>
        body {
            margin: 0;
            padding: 0;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            overflow-x: hidden;
            background: #000000;
        }

        .main-content {
            display: flex;
            height: 75vh; /* Reduce height to make room for policy section */
        }

        #map-container {
            width: 75%;
            height: 100%;
            position: relative;
            background: radial-gradient(circle at center, #0B3D91 0%, #000000 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 0 20px;  /* Add padding to match search container */
        }

        #map {
            width: 100%;
            height: 90%;
            border-radius: 20px;
            overflow: hidden;
            box-shadow: 0 0 50px rgba(11, 61, 145, 0.3);
        }

        .map-overlay {
            position: absolute;
            top: 20px;
            right: 20px;
            background: white;
            padding: 10px;
            border-radius: 4px;
            box-shadow: 0 0 10px rgba(0,0,0,0.1);
            z-index: 1;
        }

        #chat-container {
            width: 25%;
            height: 100vh;
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-left: 1px solid rgba(255, 255, 255, 0.2);
            display: flex;
            flex-direction: column;
        }

        #chat-messages {
            flex-grow: 1;
            overflow-y: auto;
            padding: 20px;
            background: #f5f5f5;
        }

        #chat-input-container {
            padding: 20px;
            border-top: 1px solid #ccc;
            background: white;
        }

        #chat-input {
            width: 100%;
            padding: 10px;
            border: 1px solid #ccc;
            border-radius: 4px;
            margin-bottom: 10px;
            resize: none;
        }

        #send-button {
            width: 100%;
            padding: 10px;
            background: #4CAF50;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }

        #send-button:hover {
            background: #45a049;
        }

        .message {
            margin-bottom: 15px;
            padding: 10px;
            border-radius: 4px;
            max-width: 80%;
        }

        .user-message {
            background: #e3f2fd;
            margin-left: auto;
        }

        .agent-message {
            background: white;
            margin-right: auto;
        }

        /* Add new styles */
        .search-container {
            position: relative;
            width: calc(75% - 20px);  /* Match map width minus padding */
            margin: 0;  /* Remove margin */
            z-index: 1;
            display: flex;
            gap: 10px;
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border-radius: 12px;
            padding: 5px;
            border: 1px solid rgba(255, 255, 255, 0.2);
            margin-bottom: 15px;
        }

        .search-bar {
            flex-grow: 1;
            padding: 12px 20px;
            font-size: 16px;
            border: 1px solid #ddd;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            background: rgba(255, 255, 255, 0.9);
        }

        .map-type-buttons {
            position: absolute;
            top: 20px;
            right: 20px;  /* Changed from right: 27% to right: 20px */
            z-index: 2;   /* Increased z-index to ensure buttons appear above map */
            display: flex;
            gap: 10px;
        }

        .map-type-button {
            padding: 8px 16px;
            background: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(10px);
            border: 1px solid #ddd;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.3s ease;
        }

        .map-type-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
        }

        .map-type-button.active {
            background: #e8f0fe;
            border-color: #4285f4;
            color: #4285f4;
        }

        .policy-cards-container {
            width: calc(75% - 20px);  /* Match search container width */
            padding: 10px 0;  /* Remove left padding */
            margin-left: 0;  /* Align with search bar */
            display: flex;
            gap: 20px;
            overflow-x: auto;
            height: 100%;
        }

        .policy-card {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 8px;
            padding: 20px;
            min-width: 300px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            transition: all 0.3s ease;
        }

        .policy-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 16px rgba(0, 0, 0, 0.2);
        }

        .policy-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .policy-title {
            font-size: 18px;
            font-weight: bold;
            margin: 0;
        }

        .policy-status {
            padding: 4px 12px;
            border-radius: 16px;
            font-size: 14px;
        }

        .status-active {
            background: #e7f5e7;
            color: #2e7d32;
        }

        .status-proposed {
            background: #fff3e0;
            color: #ef6c00;
        }

        .policy-location {
            display: flex;
            align-items: center;
            gap: 8px;
            color: #666;
            margin-bottom: 15px;
        }

        .policy-metrics {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 15px;
            text-align: center;
        }

        .metric-value {
            font-size: 24px;
            font-weight: bold;
            color: #333;
        }

        .metric-label {
            font-size: 12px;
            color: #666;
        }

        .legend {
            position: absolute;
            bottom: 20px;
            left: 20px;
            background: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(10px);
            padding: 10px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            z-index: 1;
        }

        .legend-item {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 5px;
        }

        .legend-color {
            width: 20px;
            height: 20px;
            border-radius: 4px;
        }

        /* Add star field animation */
        .stars {
            position: absolute;
            width: 100%;
            height: 100%;
            pointer-events: none;
            background-image: 
                radial-gradient(2px 2px at 20px 30px, #fff, rgba(0,0,0,0)),
                radial-gradient(2px 2px at 40px 70px, #fff, rgba(0,0,0,0)),
                radial-gradient(2px 2px at 50px 160px, #fff, rgba(0,0,0,0)),
                radial-gradient(2px 2px at 90px 40px, #fff, rgba(0,0,0,0)),
                radial-gradient(2px 2px at 130px 80px, #fff, rgba(0,0,0,0));
            background-repeat: repeat;
            animation: stars 100s linear infinite;
            opacity: 0.3;
        }

        @keyframes stars {
            from {
                transform: translateY(0);
            }
            to {
                transform: translateY(-100%);
            }
        }

        /* Add a subtle glow effect to the map */
        .map-glow {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            pointer-events: none;
            box-shadow: inset 0 0 100px rgba(11, 61, 145, 0.3);
            border-radius: 20px;
        }

        /* Update scrollbar styling for policy container */
        .policy-cards-container::-webkit-scrollbar {
            height: 8px;
        }

        .policy-cards-container::-webkit-scrollbar-track {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 4px;
        }

        .policy-cards-container::-webkit-scrollbar-thumb {
            background: rgba(255, 255, 255, 0.3);
            border-radius: 4px;
        }

        .policy-cards-container::-webkit-scrollbar-thumb:hover {
            background: rgba(255, 255, 255, 0.5);
        }

        /* Add these styles in the <style> section */
        .mapboxgl-ctrl-bottom-right,
        .mapboxgl-ctrl-bottom-left {
            display: none !important;
        }

        /* Update policy section styling */
        .policy-section {
            display: flex;
            flex-direction: column;
            align-items: flex-start;  /* Align items to the left */
            padding: 20px 0 10px 20px;  /* Add left padding to match map container */
            width: 100%;
            background: rgba(0, 0, 0, 0.3);
        }

        /* Update search container styling */
        .search-container {
            width: calc(75% - 20px);  /* Match map width minus padding */
            margin: 0;  /* Remove margin */
            z-index: 1;
            display: flex;
            gap: 10px;
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border-radius: 12px;
            padding: 5px;
            border: 1px solid rgba(255, 255, 255, 0.2);
            margin-bottom: 15px;
        }

        .search-bar {
            flex-grow: 1;
            padding: 12px 20px;
            font-size: 16px;
            border: 1px solid #ddd;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            background: rgba(255, 255, 255, 0.9);
        }
    </style>
</head>
<body>
    <div class="main-content">
        <div id="map-container">
            <div class="stars"></div>
            <div id="map"></div>
            <div class="map-glow"></div>
            
            <!-- Map Type Buttons -->
            <div class="map-type-buttons">
                <button class="map-type-button active">Satellite</button>
                <button class="map-type-button">Terrain</button>
            </div>

            <!-- Legend -->
            <div class="legend">
                <div class="legend-item">
                    <div class="legend-color" style="background: #ff1744"></div>
                    <span>Critical Impact</span>
                </div>
                <div class="legend-item">
                    <div class="legend-color" style="background: #ff4444"></div>
                    <span>High Impact</span>
                </div>
                <div class="legend-item">
                    <div class="legend-color" style="background: #ff8a65"></div>
                    <span>Medium-High Impact</span>
                </div>
                <div class="legend-item">
                    <div class="legend-color" style="background: #ffbb33"></div>
                    <span>Medium Impact</span>
                </div>
                <div class="legend-item">
                    <div class="legend-color" style="background: #79c879"></div>
                    <span>Medium-Low Impact</span>
                </div>
                <div class="legend-item">
                    <div class="legend-color" style="background: #00C851"></div>
                    <span>Low Impact</span>
                </div>
                <div class="legend-item">
                    <div class="legend-color" style="background: #00e676"></div>
                    <span>Minimal Impact</span>
                </div>
            </div>
        </div>

        <div id="chat-container">
            <div id="chat-messages">
                <!-- Messages will be dynamically added here -->
                <div class="message agent-message">
                    Hello! I'm your environmental data assistant. How can I help you today?
                </div>
            </div>
            <div id="chat-input-container">
                <textarea 
                    id="chat-input" 
                    placeholder="Type your message here..." 
                    rows="3"
                ></textarea>
                <button id="send-button">Send</button>
            </div>
        </div>
    </div>

    <!-- New Policy Section -->
    <div class="policy-section">
        <div class="search-container">
            <input type="text" class="search-bar" placeholder="Search policies or regions...">
        </div>
        <div class="policy-cards-container">
            <!-- Policy cards remain the same -->
            <div class="policy-card">
                <div class="policy-header">
                    <h3 class="policy-title">Water Management Policy</h3>
                    <span class="policy-status status-active">Active</span>
                </div>
                <div class="policy-location">
                    <span>üìç Sub-Saharan Africa</span>
                </div>
                <div class="policy-metrics">
                    <div class="metric">
                        <div class="metric-value">5000</div>
                        <div class="metric-label">Hectares Restored</div>
                    </div>
                    <div class="metric">
                        <div class="metric-value">120</div>
                        <div class="metric-label">Communities</div>
                    </div>
                    <div class="metric">
                        <div class="metric-value">85%</div>
                        <div class="metric-label">Cost Efficiency</div>
                    </div>
                </div>
            </div>

            <div class="policy-card">
                <div class="policy-header">
                    <h3 class="policy-title">Sustainable Agriculture Initiative</h3>
                    <span class="policy-status status-proposed">Proposed</span>
                </div>
                <div class="policy-location">
                    <span>üìç South Asia</span>
                </div>
                <div class="policy-metrics">
                    <div class="metric">
                        <div class="metric-value">3000</div>
                        <div class="metric-label">Hectares Restored</div>
                    </div>
                    <div class="metric">
                        <div class="metric-value">75</div>
                        <div class="metric-label">Communities</div>
                    </div>
                    <div class="metric">
                        <div class="metric-value">92%</div>
                        <div class="metric-label">Cost Efficiency</div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const MAPBOX_TOKEN = 'pk.eyJ1Ijoic2l2b2xjMiIsImEiOiJjbTNhbmd1dWsxM21tMmlvcms2Ym01b3J1In0.Oeee5mLjSKlT-vyBX5DpGQ';
            mapboxgl.accessToken = MAPBOX_TOKEN;

            fetch('/api/map/base')
                .then(response => response.json())
                .then(config => {
                    // Create mapbox base map
                    const map = new mapboxgl.Map({
                        container: 'map',
                        style: config.mapStyle,
                        center: [config.initialViewState.longitude, config.initialViewState.latitude],
                        zoom: config.initialViewState.zoom,
                        bearing: config.initialViewState.bearing,
                        pitch: config.initialViewState.pitch,
                        projection: 'globe',
                        antialias: true,
                        padding: {top: 100, bottom: 100}
                    });

                    // Add atmosphere and globe effects
                    map.on('style.load', () => {
                        map.setFog({
                            'color': 'rgb(186, 210, 235)',
                            'high-color': 'rgb(36, 92, 223)',
                            'horizon-blend': 0.02,
                            'space-color': 'rgb(11, 11, 25)',
                            'star-intensity': 0.6
                        });

                        // Add terrain and sky layers
                        map.addSource('mapbox-dem', {
                            'type': 'raster-dem',
                            'url': 'mapbox://mapbox.terrain-rgb',
                            'tileSize': 512,
                            'maxzoom': 14
                        });

                        map.setTerrain({
                            'source': 'mapbox-dem',
                            'exaggeration': 1.5
                        });

                        map.addLayer({
                            'id': 'sky',
                            'type': 'sky',
                            'paint': {
                                'sky-type': 'atmosphere',
                                'sky-atmosphere-sun': [0.0, 90.0],
                                'sky-atmosphere-sun-intensity': 15
                            }
                        });

                        // Set initial pitch for globe view
                        map.setPitch(50);

                        // Load policy data
                        fetch('/api/map/policy/water_management')
                            .then(response => response.json())
                            .then(policyData => {
                                // Add source for policy data
                                map.addSource('policy-data', {
                                    type: 'geojson',
                                    data: policyData
                                });

                                // Add layer for policy hexagons
                                map.addLayer({
                                    'id': 'policy-hexagons',
                                    'type': 'fill',
                                    'source': 'policy-data',
                                    'paint': {
                                        'fill-color': ['get', 'color'],
                                        'fill-opacity': 0.6
                                    }
                                });

                                // Add outline layer
                                map.addLayer({
                                    'id': 'policy-hexagons-outline',
                                    'type': 'line',
                                    'source': 'policy-data',
                                    'paint': {
                                        'line-color': '#ffffff',
                                        'line-width': 1,
                                        'line-opacity': 0.5
                                    }
                                });

                                // Add hover effect
                                let currentPopup = null;  // Store reference to current popup

                                map.on('mousemove', 'policy-hexagons', (e) => {
                                    if (e.features.length > 0) {
                                        const feature = e.features[0];
                                        const metrics = feature.properties.metrics;
                                        
                                        // Remove existing popup if it exists
                                        if (currentPopup) {
                                            currentPopup.remove();
                                        }
                                        
                                        // Update popup content
                                        const popupContent = `
                                            <strong>Impact Level:</strong> ${feature.properties.impact_level}<br>
                                            <strong>Hectares Restored:</strong> ${metrics.hectares_restored}<br>
                                            <strong>Communities Affected:</strong> ${metrics.communities_affected}<br>
                                            <strong>Cost Efficiency:</strong> ${metrics.cost_efficiency}
                                        `;
                                        
                                        // Create new popup and store reference
                                        currentPopup = new mapboxgl.Popup()
                                            .setLngLat(e.lngLat)
                                            .setHTML(popupContent)
                                            .addTo(map);
                                    }
                                });

                                // Add mouseleave event to remove popup when leaving hexagons
                                map.on('mouseleave', 'policy-hexagons', () => {
                                    if (currentPopup) {
                                        currentPopup.remove();
                                        currentPopup = null;
                                    }
                                });
                            });
                    });

                    // Add zoom controls
                    map.addControl(new mapboxgl.NavigationControl(), 'top-left');

                    // Adjust pitch based on zoom level
                    map.on('zoom', () => {
                        const currentZoom = map.getZoom();
                        if (currentZoom < 2) {
                            map.setPitch(50);  // Adjusted for better globe view
                        } else if (currentZoom > 5) {
                            map.setPitch(0);
                        } else {
                            // Smooth transition between globe and flat view
                            const pitch = Math.max(0, 50 * (5 - currentZoom) / 3);
                            map.setPitch(pitch);
                        }
                    });
                })
                .catch(error => {
                    console.error('Error initializing map:', error);
                });

            // Chat functionality
            const chatInput = document.getElementById('chat-input');
            const sendButton = document.getElementById('send-button');
            const chatMessages = document.getElementById('chat-messages');

            function addMessage(message, isUser = false) {
                const messageDiv = document.createElement('div');
                messageDiv.className = `message ${isUser ? 'user-message' : 'agent-message'}`;
                messageDiv.textContent = message;
                chatMessages.appendChild(messageDiv);
                chatMessages.scrollTop = chatMessages.scrollHeight;
            }

            function handleSend() {
                const message = chatInput.value.trim();
                if (message) {
                    addMessage(message, true);
                    chatInput.value = '';
                    // TODO: Send message to backend and handle response
                    // For now, just mock a response
                    setTimeout(() => {
                        addMessage("I received your message. This is a placeholder response.");
                    }, 1000);
                }
            }

            sendButton.addEventListener('click', handleSend);
            chatInput.addEventListener('keypress', (e) => {
                if (e.key === 'Enter' && !e.shiftKey) {
                    e.preventDefault();
                    handleSend();
                }
            });
        });
    </script>
</body>
</html> 